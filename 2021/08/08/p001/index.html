<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>node中使用jwt实现token身份验证</title><meta name="description" content="描述描述描述"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="Cookie认证机制
用户向服务器发送用户名和密码
服务器验证通过后，在当前对话（session）里面保存相关数据，比如用户角色、登录时间等等
服务器向用户返回一个session_id，写入用户的Cookie
用户随后的每一次请求，都会通过 Cookie，将 session_id 传回服务器
服务器收到 session_id，找到前期保存的数据，由此得知用户的身份

Token认证机制我之前一直以为cookie和token是一样的，就是后台返回一个字符串保存在前端，之后的请求都带着这个字符串，后台去做校验，深入了解后知道两者是有很大区别的，是两种不同的机制。cookie认证需要后台存一份session_id到数据库，多服务器时需要session共享。而token认证则不需要后台保存，token一般放在HTT.."><meta name="generator" content="Hexo 7.3.0"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">mu's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">node中使用jwt实现token身份验证</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Cookie%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6"><span class="toc-text">Cookie认证机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Token%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6"><span class="toc-text">Token认证机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT"><span class="toc-text">JWT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jwt%E5%AE%9E%E7%8E%B0token%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81"><span class="toc-text">jwt实现token身份验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-text">参考链接</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/node"><i class="tag post-item-tag">node</i></a><a href="/tags/jwt"><i class="tag post-item-tag">jwt</i></a><a href="/tags/cookie"><i class="tag post-item-tag">cookie</i></a><a href="/tags/token"><i class="tag post-item-tag">token</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">node中使用jwt实现token身份验证</h1><time class="has-text-grey" datetime="2021-08-07T16:00:00.000Z">2021-08-08</time><article class="mt-2 post-content"><h2 id="Cookie认证机制"><a href="#Cookie认证机制" class="headerlink" title="Cookie认证机制"></a>Cookie认证机制</h2><ol>
<li>用户向服务器发送用户名和密码</li>
<li>服务器验证通过后，在当前对话（session）里面保存相关数据，比如用户角色、登录时间等等</li>
<li>服务器向用户返回一个session_id，写入用户的Cookie</li>
<li>用户随后的每一次请求，都会通过 Cookie，将 session_id 传回服务器</li>
<li>服务器收到 session_id，找到前期保存的数据，由此得知用户的身份</li>
</ol>
<h2 id="Token认证机制"><a href="#Token认证机制" class="headerlink" title="Token认证机制"></a>Token认证机制</h2><p>我之前一直以为cookie和token是一样的，就是后台返回一个字符串保存在前端，之后的请求都带着这个字符串，后台去做校验，深入了解后知道两者是有很大区别的，是两种不同的机制。<br>cookie认证需要后台存一份session_id到数据库，多服务器时需要session共享。而token认证则不需要后台保存，token一般放在HTTP请求头的Authorization中。</p>
<h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><p>JSON Web Token (JWT)是一种开放标准，使用数字签名安全传输信息。JWT常用场景：授权（Authorization）和信息交换（Information Exchange）。授权是最常用JWT的场景。<br>JWT就是一个由‘.’分隔的字符串，这个字符串包含三个部分：Header、Payload、Signature。因此JWT的形式就是xxxxx.yyyyy.zzzzz。</p>
<h2 id="jwt实现token身份验证"><a href="#jwt实现token身份验证" class="headerlink" title="jwt实现token身份验证"></a>jwt实现token身份验证</h2><ol>
<li><p>在express项目中安装jsonwebtoken依赖</p>
<pre><code class="hljs plaintext">npm i jsonwebtoken --save</code></pre>
</li>
<li><p>新建authorization.js</p>
<pre><code class="hljs plaintext">const jwt = require(&quot;jsonwebtoken&quot;);

const secretKey = &quot;secretKey&quot;;

// 生成token
module.exports.generateToken = function (payload) &#123; 
  const token =
    &quot;Bearer &quot; +
    jwt.sign(payload, secretKey, &#123;
      expiresIn: 60 * 60,
    &#125;);
  return token;
&#125;;

// 验证token
module.exports.verifyToken = function (req, res, next) &#123;
  const token = req.headers.authorization.split(&quot; &quot;)[1];
  jwt.verify(token, secretKey, function (err, decoded) &#123;
    if (err) &#123;
      console.log(&quot;verify error&quot;, err);
      return res.json(&#123; code: &quot;404&quot;, msg: &quot;token无效&quot; &#125;);
    &#125;
    console.log(&quot;verify decoded&quot;, decoded);
    next();
  &#125;);
&#125;;</code></pre>
<p><strong>注意：生成 token 时加了前缀’Bearer ‘，验证时要把’Bearer ‘去掉， req.headers.authorization.split(“ “)[1]，不然会出现JsonWebTokenError: invalid token的错误，验证失败。</strong></p>
</li>
<li><p>登录接口生成token返回给前端</p>
<pre><code class="hljs plaintext">// login.js
const express = require(&quot;express&quot;);
const router = express.Router();
const &#123; generateToken &#125; = require(&quot;./authorization&quot;);

// 路由
router.post(&quot;/&quot;, (req, res) =&gt; &#123;
  const username = req.body.username;
  const password = req.body.password;
  const token = generateToken(&#123; username: username &#125;);
  res.json(&#123;
    code: 200,
    msg: &quot;登录成功&quot;,
    data: &#123; token &#125;,
  &#125;);
&#125;);

module.exports = router;</code></pre>
</li>
<li><p>在app.js中注册中间件</p>
<pre><code class="hljs plaintext">const loginRouter = require(&quot;./login&quot;);
const auth = require(&quot;./authorization&quot;);
const userRouter = require(&quot;./user&quot;);

app.use(&quot;/api/login&quot;, loginRouter);
app.use(&quot;/api/*&quot;, auth.verifyToken); // 注册token验证中间件
app.use(&quot;/api/user&quot;, userRouter);</code></pre>
<p><strong>注意：验证token的中间件要放在login路由之后，其他需要验证的路由之前</strong></p>
</li>
<li><p>验证接口</p>
</li>
</ol>
<p>登录：</p>
<img src="/2021/08/08/p001/image.png" class="" title="登录">

<p>获取用户列表：</p>
<img src="/2021/08/08/p001/image-1.png" class="" title="获取用户列表">

<p>无效token：</p>
<img src="/2021/08/08/p001/image-2.png" class="" title="无效token">


<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="noopener" href="https://jwt.io/introduction">JWT官网</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/auth0/node-jsonwebtoken">node-jsonwebtoken</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html">阮一峰-JSON Web Token 入门教程</a></p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2023/09/22/p002/" title="你搞懂module.exports和exports了吗？"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一页: 你搞懂module.exports和exports了吗？</span></a></section><article class="mt-6 comment-container"><script async repo="Haojen/Claudia-theme-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/mmmying"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> mu 2024</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>